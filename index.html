<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>College Mess Menu & Complaints</title>
    <!-- Load Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0d9488; /* Teal */
            --secondary-color: #38bdf8; /* Sky Blue */
            --background-color: #f0fdfa; /* Light Aqua */
            --green-indicator: #2ecc71;
            --red-indicator: #ef4444;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: #1f2937;
        }
        .meal-card {
            transition: all 0.3s ease;
        }
        .indicator {
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            margin-left: 8px;
            transition: background-color 0.5s;
        }
        .indicator.red { background-color: var(--red-indicator); }
        .indicator.green { background-color: var(--green-indicator); }
        .tab-button.active {
            border-bottom: 3px solid var(--secondary-color);
            color: var(--primary-color);
            font-weight: 700;
        }
        .table-header {
            background-color: var(--primary-color);
            color: white;
        }
        .table-row-even {
            background-color: #f9fafb;
        }
        .table-row-odd {
            background-color: #ffffff;
        }
        .complaint-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-2xl p-6 md:p-10">

        <header class="text-center mb-8 border-b pb-4">
            <h1 class="text-4xl font-extrabold text-gray-800">
                üçΩÔ∏è College Mess Portal
            </h1>
            <p id="current-day-display" class="text-xl text-gray-600 mt-2"></p>
        </header>

        <!-- Tab Navigation -->
        <nav class="flex justify-center space-x-4 mb-8 border-b border-gray-200">
            <button class="tab-button py-2 px-4 text-lg text-gray-500 hover:text-gray-700 transition duration-150 active" onclick="showTab('daily-menu')">Today's Menu</button>
            <button class="tab-button py-2 px-4 text-lg text-gray-500 hover:text-gray-700 transition duration-150" onclick="showTab('weekly-menu')">Full Weekly Menu</button>
            <button class="tab-button py-2 px-4 text-lg text-gray-500 hover:text-gray-700 transition duration-150" onclick="showTab('complaint-box')">Suggestions & Complaints</button>
        </nav>

        <!-- Main Content Area -->
        <div id="content-container" class="relative">
            <div id="loading-spinner" class="loading-overlay hidden">
                <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-teal-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-gray-600">Loading App Data...</span>
            </div>

            <!-- DAILY MENU TAB -->
            <div id="daily-menu" class="tab-content">
                
                <!-- Notice Board (Updated Greeting) -->
                <section class="mb-8 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold text-yellow-800 mb-2 flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882l-7.382 7.382A2 2 0 005.636 17H18.364a2 2 0 001.414-3.414L13 5.882zM15 17h1a2 2 0 002-2v-4a2 2 0 00-2-2h-2m-4 0h-4a2 2 0 00-2 2v4a2 2 0 002 2h4"></path></svg>
                        Welcome to the Mess!
                    </h2>
                    <p class="text-yellow-700">A warm welcome to all students! Enjoy your meals and please use the 'Suggestions & Complaints' tab for any feedback regarding the food quality or service. We appreciate your input!</p>
                </section>

                <!-- Menu Grid -->
                <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Cards will be populated and toggled by JS -->
                    <div class="meal-card bg-gray-50 p-6 rounded-xl shadow-lg border border-gray-200" id="card-Breakfast">
                        <h3 class="text-xl font-bold flex items-center text-teal-700">Breakfast<span class="indicator red" id="indicator-Breakfast"></span></h3>
                        <p class="mt-3 text-gray-700" id="menu-Breakfast">Loading...</p>
                    </div>
                    <div class="meal-card bg-gray-50 p-6 rounded-xl shadow-lg border border-gray-200" id="card-Lunch">
                        <h3 class="text-xl font-bold flex items-center text-teal-700">Lunch<span class="indicator red" id="indicator-Lunch"></span></h3>
                        <p class="mt-3 text-gray-700" id="menu-Lunch">Loading...</p>
                    </div>
                    <div class="meal-card bg-gray-50 p-6 rounded-xl shadow-lg border border-gray-200" id="card-Snacks">
                        <h3 class="text-xl font-bold flex items-center text-teal-700">Snacks<span class="indicator red" id="indicator-Snacks"></span></h3>
                        <p class="mt-3 text-gray-700" id="menu-Snacks">Loading...</p>
                    </div>
                    <div class="meal-card bg-gray-50 p-6 rounded-xl shadow-lg border border-gray-200" id="card-Dinner">
                        <h3 class="text-xl font-bold flex items-center text-teal-700">Dinner<span class="indicator red" id="indicator-Dinner"></span></h3>
                        <p class="mt-3 text-gray-700" id="menu-Dinner">Loading...</p>
                    </div>
                </section>
            </div>

            <!-- WEEKLY MENU TAB -->
            <div id="weekly-menu" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">Complete Weekly Schedule</h2>
                <div class="overflow-x-auto rounded-lg shadow-xl">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th class="table-header px-6 py-3 text-left text-xs font-medium uppercase tracking-wider rounded-tl-lg">Day</th>
                                <th class="table-header px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Breakfast</th>
                                <th class="table-header px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Lunch</th>
                                <th class="table-header px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Snacks</th>
                                <th class="table-header px-6 py-3 text-left text-xs font-medium uppercase tracking-wider rounded-tr-lg">Dinner</th>
                            </tr>
                        </thead>
                        <tbody id="weekly-menu-body" class="bg-white divide-y divide-gray-200">
                            <!-- Weekly menu will be populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- COMPLAINT/SUGGESTION BOX TAB -->
            <div id="complaint-box" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div id="auth-section" class="p-6 bg-blue-50 rounded-lg shadow-md border border-blue-200">
                        <h2 class="text-2xl font-bold text-blue-700 mb-4" id="auth-header">Please Sign In to Post Feedback</h2>
                        
                        <button id="signin-button" onclick="signInWithGoogle()" 
                                class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150">
                            Sign In with IIPE Google Account
                        </button>
                        
                        <form id="complaint-form" onsubmit="submitComplaint(event)" class="hidden mt-4">
                            <p class="text-sm text-gray-600 mb-4">Signed in as: <strong id="user-email-display"></strong> <button type="button" onclick="signOutUser()" class="text-xs text-red-500 hover:text-red-700 ml-2"> (Sign Out)</button></p>
                            
                            <div class="mb-4">
                                <label for="userName" class="block text-sm font-medium text-gray-700">Your Name (Optional)</label>
                                <input type="text" id="userName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="e.g., John Doe or leave blank for anonymous" />
                            </div>
                            <div class="mb-4">
                                <label for="complaintText" class="block text-sm font-medium text-gray-700">Suggestion or Complaint Message</label>
                                <textarea id="complaintText" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="Enter your feedback here..."></textarea>
                            </div>
                            <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                                Post Feedback
                            </button>
                            <p id="form-message" class="mt-3 text-center text-sm font-medium hidden"></p>
                        </form>
                    </div>

                    <div class="p-6 bg-white rounded-lg shadow-lg border border-gray-200">
                        <h2 class="text-2xl font-bold text-gray-700 mb-4">Recent Feedback (Last 7 Days)</h2>
                        <div id="complaints-list" class="complaint-list space-y-4">
                            <p id="no-complaints" class="text-gray-500 text-center">Loading complaints...</p>
                        </div>
                    </div>
                </div>
            </div>

                    <!-- Existing Complaints Display -->
                    <div class="p-6 bg-white rounded-lg shadow-lg border border-gray-200">
                        <h2 class="text-2xl font-bold text-gray-700 mb-4">Recent Feedback (Last 7 Days)</h2>
                        <div id="complaints-list" class="complaint-list space-y-4">
                            <!-- Complaints will be loaded here -->
                            <p id="no-complaints" class="text-gray-500 text-center">Loading complaints...</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <footer>
            <p class="text-center text-xs text-gray-400 mt-8">Powered by Firebase Firestore and Gemini.</p>
        </footer>
    </div>

    <!-- Firebase Imports and Setup -->
    <script type="module">
        // Import Google-specific auth methods
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, orderBy, where, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- REAL FIREBASE CONFIGURATION (Provided by User) ---
        const REAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyDQ45Kk39x0Zm7rvDBFhxzI6UeGD8pRhqo",
            authDomain: "college-mess-75e8f.firebaseapp.com",
            projectId: "college-mess-75e8f",
            storageBucket: "college-mess-75e8f.firebasestorage.app",
            messagingSenderId: "617206629929",
            appId: "1:617206629929:web:24ec275b0a579778f3fe38",
        };
        // The application's core data structure (Menu and Time Windows remain the same)
        window.WEEKLY_MENU = {
            Monday: {
                Breakfast: "Vada Sambhar, banana/egg, Coconut Chutney, Milk, Coffee",
                Lunch: "Roti, Rice, Chole Curry, Aalu (very small 65) Palakurura Dal, Curd, Sambhar",
                Snacks: "Maggie",
                Dinner: "Roti, Rice, White peas Aloo Curry, North Dal, Curd, Pickle"
            },
            Tuesday: {
                Breakfast: "Karam Dosa, Chutney, sambhar, Milk, Coffee",
                Lunch: "Roti, Rice, Season Vegetable, Tomato dal, Butter Milk, Onions, Sambhar",
                Snacks: "SweetCorn, Tea",
                Dinner: "Roti, Rice, Black Chana Curry, Arhar/Lahar Dal, Gulab Jamun, Curd"
            },
            Wednesday: {
                Breakfast: "Idli, Sambhar, Groundnut Chutney, Milk, Coffee",
                Lunch: "Roti, Rice, Masoor Dal, Veg Kofta, Rasam, Curd, salad",
                Snacks: "Punugulu with Chutney, Tea",
                Dinner: "Roti, Rice, Paneer butter masala, Chicken Fry curry, Rasam, Curd, Salad"
            },
            Thursday: {
                Breakfast: "Poha(Sev Mix), Banana, Milk, Coffee sachet",
                Lunch: "Chola Puri, Rice, Channa Dal North, Butter-Milk(Chanch), Salad",
                Snacks: "Kachodi, tomato sause, Tea",
                Dinner: "Aloo Paratha, Curd, Tomato Sause, Pickle"
            },
            Friday: {
                Breakfast: "Onion Bonda, Chutney, Milk, Coffee",
                Lunch: "Roti, Rice, Aloo dry, Thotakura Dal, Kadhi (Curd mix), Salad",
                Snacks: "Fruit Salad",
                Dinner: "Roti, Rice, Chana Dal Tadka, Egg Curry(2)/ Aloo Matar, Curd Pickle"
            },
            Saturday: {
                Breakfast: "Onion Utappam, Chutney, Milk, Coffee",
                Lunch: "Roti, Rice, Aanapakaya Dal, Bhindi Sabji, Sambhar, Curd",
                Snacks: "Veg Puff, Tea",
                Dinner: "Roti, Rice, Manchurian Fry Soya, Moong North dal, Curd, Pickle, Semiya Kheer"
            },
            Sunday: {
                Breakfast: "Masala dosa, Sambhar, Groundnut Chutney, Milk, Coffee",
                Lunch: "Roti, Rice, Kadai Paneer, Kadai Chicken, Salad, Raita, Lemon",
                Snacks: "Pasta, Tea",
                Dinner: "Basmati Rice Biryani, Raita, Gravy, Pickle"
            }
        };

        // Define the time windows (24-hour format)
        window.MEAL_TIMES = {
            Breakfast: { start: 7, end: 9 },   // 7:00 AM to 9:00 AM
            Lunch: { start: 12, end: 14 },     // 12:00 PM to 2:00 PM
            Snacks: { start: 17, end: 19 },    // 5:00 PM to 7:00 PM (A bit longer window)
            Dinner: { start: 20, end: 22 }     // 8:00 PM to 10:00 PM
        };
        // ---------------------------------------------------

        // Domain to enforce
        const ALLOWED_DOMAIN = "iipe.ac.in";

        // Global variables provided by the environment, with REAL_FIREBASE_CONFIG as the fallback
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : REAL_FIREBASE_CONFIG;

        // Firebase Initialization and Globals for the App
        let app, db, auth, userId = null;
        let isFirebaseInitialized = false; 
        const COMPLAINTS_COLLECTION_PATH = `/artifacts/${appId}/public/data/complaints`;

        // The rest of the WEEKLY_MENU and MEAL_TIMES data is unchanged and assumed global.

        // Helper function for date formatting (Keep as is)
        const formatDate = (date) => {
            const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            return new Date(date).toLocaleDateString('en-US', options);
        };
        
        /**
         * Toggles the UI elements based on authentication state.
         * @param {object | null} user - The Firebase User object or null.
         */
        function updateAuthUI(user) {
            const authHeader = document.getElementById('auth-header');
            const signInButton = document.getElementById('signin-button');
            const complaintForm = document.getElementById('complaint-form');
            const userEmailDisplay = document.getElementById('user-email-display');

            if (user && user.email && user.email.endsWith(`@${ALLOWED_DOMAIN}`)) {
                // Logged in with correct domain
                authHeader.textContent = "Submit Your Feedback";
                signInButton.classList.add('hidden');
                complaintForm.classList.remove('hidden');
                userEmailDisplay.textContent = user.email;
                userId = user.uid; // Set internal userId
            } else {
                // Logged out or wrong domain
                authHeader.textContent = "Please Sign In to Post Feedback";
                signInButton.classList.remove('hidden');
                complaintForm.classList.add('hidden');
                userEmailDisplay.textContent = 'N/A';
                userId = null; // Clear internal userId
                
                // If user exists but has the wrong domain, sign them out immediately
                if (user) {
                    signOut(auth).then(() => {
                        console.log("Signed out user with incorrect domain.");
                        alert("Sign-in failed: Only accounts from @" + ALLOWED_DOMAIN + " are allowed.");
                    }).catch(error => console.error("Sign out error:", error));
                }
            }
        }

        /**
         * Initializes Firebase and sets up authentication listener.
         */
        async function initializeFirebase() {
            if (!firebaseConfig) {
                // Error handling unchanged
                return;
            }

            try {
                // setLogLevel('debug');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Add listener for auth state changes
                onAuthStateChanged(auth, (user) => {
                    updateAuthUI(user);
                    // Only start complaint listener once Firebase is ready
                    if (!isFirebaseInitialized) {
                        isFirebaseInitialized = true;
                        listenForComplaints(); 
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('complaint-box').innerHTML = `
                    <div class="p-6 bg-red-100 rounded-lg text-red-800">
                        <p class="font-bold">Database Error:</p>
                        <p>Failed to connect to the database. Complaint posting is disabled. Error: ${error.message}</p>
                    </div>`;
            } 
        }

        /**
         * Handles the Google Sign-In process with domain restriction.
         */
        window.signInWithGoogle = async () => {
            const provider = new GoogleAuthProvider();
            
            // Set the 'hd' (hosted domain) parameter to restrict sign-in selection to the desired domain
            // NOTE: This is a hint, not a full security measure. Firebase Security Rules must enforce this as well.
            provider.setCustomParameters({
                'hd': ALLOWED_DOMAIN
            });

            try {
                await signInWithPopup(auth, provider);
                // onAuthStateChanged listener handles successful sign-in and UI update
                
            } catch (error) {
                // Handle different sign-in errors
                const messageElement = document.getElementById('form-message');
                messageElement.classList.remove('hidden');
                
                if (error.code === 'auth/popup-closed-by-user') {
                    messageElement.textContent = "Sign-in popup closed. Please try again.";
                    messageElement.className = 'mt-3 text-center text-sm font-medium text-yellow-600';
                } else if (error.code === 'auth/cancelled-popup-request') {
                     messageElement.textContent = "Popup already open. Please complete the first request.";
                    messageElement.className = 'mt-3 text-center text-sm font-medium text-yellow-600';
                } else if (error.email && !error.email.endsWith(`@${ALLOWED_DOMAIN}`)) {
                    // This error is caught if the user selects the wrong domain *after* the popup closes,
                    // but the onAuthStateChanged should also catch it and sign them out.
                    messageElement.textContent = `Sign-in failed: Only accounts from @${ALLOWED_DOMAIN} are allowed.`;
                    messageElement.className = 'mt-3 text-center text-sm font-medium text-red-600';
                } else {
                    console.error("Sign-in error:", error);
                    messageElement.textContent = `Error during sign-in: ${error.message}`;
                    messageElement.className = 'mt-3 text-center text-sm font-medium text-red-600';
                }
                setTimeout(() => messageElement.classList.add('hidden'), 5000);
            }
        };

        /**
         * Handles signing out the current user.
         */
        window.signOutUser = async () => {
            try {
                await signOut(auth);
                // onAuthStateChanged listener handles UI update
            } catch (error) {
                console.error("Sign out error:", error);
                alert("Failed to sign out. Please try again.");
            }
        };


        /**
         * Handles fetching and displaying complaints in real-time. (Logic unchanged)
         */
        function listenForComplaints() {
            if (!db || !isFirebaseInitialized) return;

            // Calculate 7 days ago in milliseconds
            const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
            const sevenDaysAgoDate = new Date(sevenDaysAgo);

            // Query for complaints posted within the last 7 days
            const complaintsQuery = query(
                collection(db, COMPLAINTS_COLLECTION_PATH),
                where("timestamp", ">=", sevenDaysAgoDate),
                orderBy("timestamp", "desc")
            );

            onSnapshot(complaintsQuery, (snapshot) => {
                const complaintsListElement = document.getElementById('complaints-list');
                complaintsListElement.innerHTML = ''; // Clear existing complaints

                if (snapshot.empty) {
                    complaintsListElement.innerHTML = `<p class="text-gray-500 text-center p-4">No recent feedback in the last 7 days.</p>`;
                    return;
                }
                
                // Process and display the new list of complaints
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const complaintDiv = document.createElement('div');
                    complaintDiv.className = 'p-3 bg-white rounded-lg border border-gray-100 shadow-sm';
                    
                    // Use the stored userName or default to Anonymous Student (or authenticated user's email if name is blank)
                    const nameToDisplay = data.userName || data.userEmail || "Anonymous Student"; 
                    const time = data.timestamp ? formatDate(data.timestamp.toDate()) : 'Unknown Date';
                    const message = data.message || 'No message content.';
                    
                    complaintDiv.innerHTML = `
                        <p class="text-sm text-gray-800 font-medium">${message}</p>
                        <div class="flex justify-between text-xs text-gray-500 mt-1 pt-1 border-t border-gray-100">
                            <span>By: ${nameToDisplay}</span>
                            <span>Posted: ${time}</span>
                        </div>
                    `;
                    complaintsListElement.appendChild(complaintDiv);
                });

            }, (error) => {
                console.error("Error listening to complaints:", error);
                document.getElementById('complaints-list').innerHTML = `<p class="text-red-500 text-center p-4">Error loading feedback. Please try again.</p>`;
            });
        }

        /**
         * Submits a new complaint/suggestion to Firestore.
         */
        window.submitComplaint = async (event) => {
            event.preventDefault();
            const userNameInput = document.getElementById('userName');
            const complaintTextarea = document.getElementById('complaintText');
            const messageElement = document.getElementById('form-message');
            
            const name = userNameInput.value.trim(); // Capture name
            const message = complaintTextarea.value.trim();
            const currentUser = auth.currentUser;

            if (!message) {
                // Unchanged validation logic
                return;
            }

            if (!currentUser || !currentUser.email.endsWith(`@${ALLOWED_DOMAIN}`)) {
                 messageElement.textContent = "You must be signed in with a valid IIPE account to post feedback.";
                messageElement.className = 'mt-3 text-center text-sm font-medium text-red-600';
                messageElement.classList.remove('hidden');
                setTimeout(() => messageElement.classList.add('hidden'), 5000);
                return;
            }

            if (!db || !isFirebaseInitialized) {
                // Database check logic unchanged
                return;
            }

            try {
                // Store both the optional user name and the authenticated user's email
                await addDoc(collection(db, COMPLAINTS_COLLECTION_PATH), {
                    userId: currentUser.uid, // Authenticated UID
                    userEmail: currentUser.email, // Authenticated Email
                    userName: name || currentUser.email.split('@')[0], // Use email prefix if name is blank
                    message: message,
                    timestamp: serverTimestamp()
                });

                complaintTextarea.value = ''; // Clear message input
                messageElement.textContent = `Thank you! Your feedback has been posted.`;
                messageElement.className = 'mt-3 text-center text-sm font-medium text-green-600';
                messageElement.classList.remove('hidden');

            } catch (error) {
                // Error handling unchanged
            }
            // Hide message after a few seconds
            setTimeout(() => messageElement.classList.add('hidden'), 5000);
        };

        // Attach Firebase init to document ready
        document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>
    
    <!-- Application Logic (Non-Module Script) -->
    <script>
        // --- Core Application Functions (outside module for global access) ---

        /**
         * Updates the menu content for the current day.
         */
        function updateDailyMenu() {
            const today = new Date().toLocaleDateString('en-US', { weekday: 'long' });
            // Fallback for WEEKLY_MENU in case module script hasn't fully loaded, though typically it should be available.
            const dailyMenu = window.WEEKLY_MENU?.[today] || {}; 
            const mealNames = ['Breakfast', 'Lunch', 'Snacks', 'Dinner'];

            document.getElementById('current-day-display').textContent = `Menu for ${today}`;

            if (Object.keys(dailyMenu).length > 0) {
                mealNames.forEach(meal => {
                    const menuElement = document.getElementById(`menu-${meal}`);
                    if (menuElement) {
                        menuElement.textContent = dailyMenu[meal] || "Menu not available.";
                    }
                });
            } else {
                 mealNames.forEach(meal => {
                    const menuElement = document.getElementById(`menu-${meal}`);
                    if (menuElement) {
                        menuElement.textContent = "Menu data unavailable. Check script file.";
                    }
                });
            }
        }

        /**
         * Checks the current time and updates the red/green indicators.
         */
        function updateIndicators() {
            const currentHour = new Date().getHours();
            const currentMinute = new Date().getMinutes();
            
            // Convert to decimal hour for more precise checks (e.g., 17:30 = 17.5)
            const currentTime = currentHour + (currentMinute / 60);

            const mealNames = ['Breakfast', 'Lunch', 'Snacks', 'Dinner'];
            
            // Fallback for MEAL_TIMES in case module script hasn't fully loaded
            const mealTimes = window.MEAL_TIMES || {}; 

            mealNames.forEach(meal => {
                const indicator = document.getElementById(`indicator-${meal}`);
                const card = document.getElementById(`card-${meal}`);
                const timeWindow = mealTimes[meal];

                if (indicator && card && timeWindow) {
                    // Check if the current time (decimal) is within the meal's time window
                    if (currentTime >= timeWindow.start && currentTime < timeWindow.end) {
                        // Time is Active: Set to Green
                        indicator.classList.remove('red');
                        indicator.classList.add('green');
                        card.classList.add('border-teal-400', 'shadow-2xl', 'scale-105');
                        card.classList.remove('border-gray-200');
                    } else {
                        // Time is Not Active: Set to Red
                        indicator.classList.remove('green');
                        indicator.classList.add('red');
                        card.classList.remove('border-teal-400', 'shadow-2xl', 'scale-105');
                        card.classList.add('border-gray-200');
                    }
                }
            });
        }

        /**
         * Populates the weekly menu table.
         */
        function renderWeeklyMenu() {
            const weeklyBody = document.getElementById('weekly-menu-body');
            weeklyBody.innerHTML = ''; // Clear previous content

            const days = Object.keys(window.WEEKLY_MENU || {});
            days.forEach((day, index) => {
                const menu = window.WEEKLY_MENU[day];
                const row = weeklyBody.insertRow();
                row.className = index % 2 === 0 ? 'table-row-even' : 'table-row-odd';
                
                row.insertCell().textContent = day;
                row.insertCell().textContent = menu.Breakfast;
                row.insertCell().textContent = menu.Lunch;
                row.insertCell().textContent = menu.Snacks;
                row.insertCell().textContent = menu.Dinner;
            });
        }

        /**
         * Handles tab switching (Daily, Weekly, Complaints).
         */
        window.showTab = function(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            document.getElementById(tabId).classList.remove('hidden');
            document.querySelector(`.tab-button[onclick*='${tabId}']`).classList.add('active');
            
            // Rerender weekly menu only when its tab is clicked
            if (tabId === 'weekly-menu') {
                renderWeeklyMenu();
            }
        };


        // --- Initialization ---
        
        /**
         * Runs the initial setup for the UI (Menus, Indicators).
         */
        function initAppLogic() {
            // Hide loading spinner and show content
            document.getElementById('loading-spinner').classList.add('hidden');
            document.getElementById('content-container').classList.remove('relative');

            // Initial setup for the daily menu and indicators
            updateDailyMenu();
            updateIndicators();
            // Start a timer to check the indicators every 30 seconds
            setInterval(updateIndicators, 30000); 
            
            // Set default tab to daily menu
            showTab('daily-menu'); 
        }

        // Initial setup for the daily menu and indicators
        document.addEventListener('DOMContentLoaded', initAppLogic);
    </script>
</body>
</html>
